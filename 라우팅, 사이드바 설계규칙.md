# 라우팅 & 사이드바 설계 규칙

## 1. 핵심 원칙

```
menu.code === permission.code === routeMap 키
```

| 구성요소 | 역할 | 위치 |
|----------|------|------|
| `menus_menu` | UI 트리 구조 (사이드바) | DB |
| `accounts_permission` | 접근 제어 | DB |
| `routeMap` | code → React 컴포넌트 매핑 | Frontend |

---

## 2. 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                         [Backend DB]                                │
│  ┌─────────────┐    ┌───────────────────┐    ┌──────────────────┐  │
│  │ menus_menu  │───▶│ menus_menupermission│◀──│accounts_permission│  │
│  │  (UI 트리)  │    │    (메뉴↔권한)     │    │   (접근 제어)    │  │
│  └─────────────┘    └───────────────────┘    └──────────────────┘  │
│                                                       ▲             │
│                                                       │             │
│                              ┌────────────────────────┴───────┐     │
│                              │ accounts_role_permissions      │     │
│                              │      (역할↔권한)               │     │
│                              └────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼ 로그인 시 전달
┌─────────────────────────────────────────────────────────────────────┐
│                         [Frontend]                                  │
│                                                                     │
│  AuthProvider에서 menus[], permissions[] 보관                       │
│                     │                                               │
│         ┌──────────┴──────────┐                                    │
│         ▼                     ▼                                    │
│  ┌─────────────┐       ┌─────────────┐                             │
│  │  Sidebar    │       │  AppRoutes  │                             │
│  │ (UI 렌더링) │       │ (라우트 생성)│                             │
│  └─────────────┘       └─────────────┘                             │
│         │                     │                                    │
│         └─────────┬───────────┘                                    │
│                   ▼                                                │
│            ┌─────────────┐                                         │
│            │  routeMap   │  code → Component 매핑                  │
│            └─────────────┘                                         │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. DB 테이블 구조

### 3.1 menus_menu (메뉴 트리)

| 컬럼 | 설명 |
|------|------|
| `id` | PK |
| `code` | 고유 식별자 (UNIQUE) - **routeMap 키와 일치** |
| `path` | URL 경로 (null이면 그룹 메뉴) |
| `icon` | FontAwesome 아이콘명 |
| `parent_id` | 부모 메뉴 FK (self-reference) |
| `breadcrumb_only` | 1이면 사이드바에 표시 안 함 (상세 페이지용) |
| `order` | 정렬 순서 |
| `is_active` | 활성화 여부 |

### 3.2 accounts_permission (권한)

| 컬럼 | 설명 |
|------|------|
| `id` | PK |
| `code` | 권한 코드 (UNIQUE) - **menu.code와 일치** |
| `name` | 권한명 |
| `description` | 설명 |

### 3.3 menus_menulabel (역할별 라벨)

| 컬럼 | 설명 |
|------|------|
| `role` | 역할 코드 ('DEFAULT', 'DOCTOR', 'NURSE' 등) |
| `text` | 표시할 라벨 |
| `menu_id` | 메뉴 FK |

---

## 4. Frontend 구조

### 4.1 routeMap.tsx - 메뉴 코드 ↔ 컴포넌트 매핑

```tsx
// DB 메뉴 code와 React 컴포넌트 연결 (계약서)
export const routeMap: Record<string, ComponentType> = {
  DASHBOARD: DashboardPage,
  PATIENT_LIST: PatientListPage,
  PATIENT_DETAIL: PatientDetailPage,
  ORDER_LIST: OrderListPage,
  ORDER_CREATE: OrderCreatePage,
  IMAGE_VIEWER: ImagingPage,
  RIS_WORKLIST: RISWorklistPage,
  AI_SUMMARY: AISummaryPage,
  LAB_RESULT_VIEW: () => <ComingSoonPage title="검사 결과 조회" />,
  LAB_RESULT_UPLOAD: () => <ComingSoonPage title="검사 결과 업로드" />,
  ADMIN_USER: UserList,
  ADMIN_USER_DETAIL: UserDetailPage,
  ADMIN_ROLE: RoleControlPage,
  ADMIN_MENU_PERMISSION: MenuPermissionPage,
  ADMIN_AUDIT_LOG: AuditLog,
  ADMIN_SYSTEM_MONITOR: SystemMonitorPage,
};
```

### 4.2 AppRoutes.tsx - 동적 라우트 생성

```tsx
// 권한 있는 메뉴만 필터링
function flattenAccessibleMenus(menus: MenuNode[], permissions: string[]): MenuNode[] {
  return menus.flatMap(menu => {
    const hasPermission = permissions.includes(menu.code);
    const children = menu.children ? flattenAccessibleMenus(menu.children, permissions) : [];

    if (menu.path && hasPermission && !menu.breadcrumbOnly) {
      return [menu, ...children];
    }
    return children;
  });
}

// 라우트 동적 생성
{accessibleMenus.map(menu => {
  const Component = routeMap[menu.code];
  if (!Component) return null;

  return (
    <Route
      key={menu.code}
      path={menu.path!}
      element={<ProtectedRoute><Component /></ProtectedRoute>}
    />
  );
})}
```

### 4.3 Sidebar - 역할별 라벨 표시

```tsx
// SidebarItem.tsx
const { role } = useAuth();
const roleKey = role ?? 'DEFAULT';

// 역할별 라벨 우선순위: role별 라벨 → DEFAULT → code
const label = menu.labels?.[roleKey] || menu.labels?.['DEFAULT'] || menu.code;
```

### 4.4 MenuNode 타입

```tsx
interface MenuNode {
  id: number;
  code: string;                      // 'DASHBOARD', 'ADMIN' 등
  icon?: string;                     // FontAwesome 아이콘
  labels: Record<string, string>;    // { DEFAULT: '대시보드', DOCTOR: '의사 대시보드' }
  breadcrumbOnly: boolean;           // true면 사이드바에 표시 안 함
  path?: string;                     // URL 경로
  children?: MenuNode[];             // 하위 메뉴
}
```

---

## 5. 메뉴 유형

### 5.1 그룹 메뉴 (path = NULL)
- 사이드바에서 펼침/접힘 가능한 부모 메뉴
- 예: PATIENT, ORDER, IMAGING, LAB, ADMIN

### 5.2 화면 메뉴 (path 존재, breadcrumb_only = 0)
- 사이드바에 표시되고 클릭 시 해당 화면으로 이동
- 예: DASHBOARD, PATIENT_LIST, ORDER_LIST

### 5.3 숨김 메뉴 (breadcrumb_only = 1)
- 사이드바에 표시되지 않음
- 상세 페이지 등 다른 화면에서 진입
- 예: PATIENT_DETAIL, ORDER_CREATE, ADMIN_USER_DETAIL

---

## 6. 역할별 권한 매핑

| 역할 | 접근 가능 메뉴 |
|------|---------------|
| **SYSTEMMANAGER** | 모든 메뉴 |
| **ADMIN** | 대시보드, 환자, 오더, 영상, 검사, AI, 관리자(시스템 모니터링 제외) |
| **DOCTOR** | 대시보드, 환자 목록/상세, 오더 목록, 영상 뷰어, RIS Worklist |
| **NURSE** | 대시보드, 환자 목록/상세, 오더 목록, 영상 뷰어, 검사 결과 조회 |
| **RIS** | 대시보드, 영상 뷰어, RIS Worklist |
| **LIS** | 대시보드, 검사 결과 조회/업로드 |

---

## 7. 새 메뉴 추가 절차

### Step 1: DB에 메뉴 추가
```sql
-- 1. menus_menu에 메뉴 추가
INSERT INTO menus_menu (code, path, icon, parent_id, breadcrumb_only, `order`, is_active)
VALUES ('NEW_MENU', '/new-path', 'icon-name', {parent_id}, 0, 1, 1);

-- 2. accounts_permission에 권한 추가 (code 일치 필수!)
INSERT INTO accounts_permission (code, name, description)
VALUES ('NEW_MENU', '새 메뉴', '새 메뉴 설명');

-- 3. menus_menupermission 연결 (자동 매핑 쿼리 사용 가능)
INSERT INTO menus_menupermission (menu_id, permission_id)
SELECT m.id, p.id FROM menus_menu m
JOIN accounts_permission p ON m.code = p.code
WHERE m.code = 'NEW_MENU';

-- 4. 역할에 권한 부여
INSERT INTO accounts_role_permissions (role_id, permission_id)
SELECT r.id, p.id FROM accounts_role r
JOIN accounts_permission p ON p.code = 'NEW_MENU'
WHERE r.code IN ('SYSTEMMANAGER', 'ADMIN');

-- 5. 메뉴 라벨 추가
INSERT INTO menus_menulabel (role, text, menu_id)
VALUES ('DEFAULT', '새 메뉴', {menu_id});
```

### Step 2: Frontend에 컴포넌트 추가
```tsx
// 1. 페이지 컴포넌트 생성
// src/pages/new/NewMenuPage.tsx

// 2. routeMap에 등록
// src/router/routeMap.tsx
import NewMenuPage from '@/pages/new/NewMenuPage';

export const routeMap: Record<string, ComponentType> = {
  // ... 기존 메뉴들
  NEW_MENU: NewMenuPage,
};
```

---

## 8. 메뉴 삭제 절차

```sql
-- 순서 중요! FK 제약조건 때문에 역순으로 삭제

-- 1. ROLE ↔ PERMISSION 연결 삭제
DELETE rp FROM accounts_role_permissions rp
JOIN accounts_permission p ON p.id = rp.permission_id
WHERE p.code = 'TARGET_MENU';

-- 2. MENU ↔ PERMISSION 연결 삭제
DELETE mp FROM menus_menupermission mp
JOIN menus_menu m ON m.id = mp.menu_id
WHERE m.code = 'TARGET_MENU';

-- 3. 메뉴 라벨 삭제
DELETE ml FROM menus_menulabel ml
JOIN menus_menu m ON m.id = ml.menu_id
WHERE m.code = 'TARGET_MENU';

-- 4. PERMISSION 삭제
DELETE FROM accounts_permission WHERE code = 'TARGET_MENU';

-- 5. MENU 삭제
DELETE FROM menus_menu WHERE code = 'TARGET_MENU';
```

---

## 9. 검증 쿼리

```sql
-- menu.code와 permission.code 불일치 확인 (0건이어야 정상)
SELECT m.code AS menu_code, p.code AS permission_code
FROM menus_menu m
JOIN menus_menupermission mp ON mp.menu_id = m.id
JOIN accounts_permission p ON p.id = mp.permission_id
WHERE m.code != p.code;

-- 역할별 권한 수 확인
SELECT r.code, COUNT(*) AS permission_count
FROM accounts_role_permissions rp
JOIN accounts_role r ON r.id = rp.role_id
GROUP BY r.code;

-- routeMap에 없는 메뉴 확인 (Frontend에서 수동 확인 필요)
SELECT code, path FROM menus_menu
WHERE path IS NOT NULL AND breadcrumb_only = 0;
```

---

## 10. 주의사항

1. **code 일치 필수**: `menus_menu.code`, `accounts_permission.code`, `routeMap` 키는 반드시 동일해야 함
2. **breadcrumb_only 메뉴**: 권한은 필요하지만 사이드바에 표시하지 않을 때 사용
3. **그룹 메뉴 권한**: 그룹 메뉴(path=NULL)도 permission이 있어야 하위 메뉴 접근 가능
4. **역할별 라벨**: DEFAULT 라벨은 필수, 역할별 커스텀 라벨은 선택
5. **라우트 보호**: 모든 화면은 `ProtectedRoute`로 감싸서 인증 체크
