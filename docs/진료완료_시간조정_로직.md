# 진료 완료 시 시간 조정 로직

## 문제 상황

예약된 미래 시간에 진료가 예정되어 있는데, 실제로는 그 전에 진료를 완료하는 경우:

```
예약 시간(admission_date): 2025-01-20 14:00  (미래)
진료 완료 시점(discharge_date): 2025-01-18 10:30  (현재)
```

이 경우 `discharge_date < admission_date`가 되어 모델 validation 오류 발생:

```
ValidationError: {'__all__': ['퇴원 일시는 입원 일시보다 이후여야 합니다.']}
```

## 해결 방법

진료 완료 시점에 `admission_date`가 `discharge_date`보다 미래인 경우, `admission_date`를 `discharge_date` 1분 전으로 자동 조정합니다.

### 왜 1분 전인가?

1. **진료 기록의 현실성**: 실제 진료가 이루어졌으므로 최소한의 진료 시간(1분)이 기록됨
2. **의료 기록 관점**: 진료 시작과 종료 시간이 동일하면 "진료 없음"으로 해석될 수 있음
3. **시간순 정렬 보장**: `admission_date < discharge_date` 관계가 항상 유지됨

## 수정된 코드

### `apps/encounters/views.py` - `complete` 액션

```python
@action(detail=True, methods=['post'])
def complete(self, request, pk=None):
    """진료 완료 처리"""
    try:
        encounter = self.get_object()

        if encounter.status == 'completed':
            return Response(
                {'detail': '이미 완료된 진료입니다.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        with transaction.atomic():
            encounter = Encounter.objects.select_for_update().get(pk=encounter.pk)

            if encounter.status == 'completed':
                return Response(
                    {'detail': '이미 완료된 진료입니다.'},
                    status=status.HTTP_400_BAD_REQUEST
                )

            encounter.status = 'completed'
            now = timezone.now()

            if not encounter.discharge_date:
                encounter.discharge_date = now

            # 예약 시간(admission_date)이 퇴원 시간보다 미래인 경우
            # 실제 진료 시간으로 조정 (퇴원 1분 전으로 설정)
            update_fields = ['status', 'discharge_date']
            if encounter.admission_date and encounter.admission_date > encounter.discharge_date:
                from datetime import timedelta
                encounter.admission_date = encounter.discharge_date - timedelta(minutes=1)
                update_fields.append('admission_date')

            # update_fields로 필요한 필드만 업데이트 (full_clean 건너뜀)
            encounter.save(update_fields=update_fields)

        serializer = self.get_serializer(encounter)
        return Response(serializer.data)

    except Encounter.DoesNotExist:
        return Response(
            {'detail': '진료를 찾을 수 없습니다.'},
            status=status.HTTP_404_NOT_FOUND
        )
    except Exception as e:
        logger.error(f'진료 완료 처리 중 오류: {e}', exc_info=True)
        return Response(
            {'detail': '진료 완료 처리 중 오류가 발생했습니다.'},
            status=status.HTTP_500_INTERNAL_SERVER_ERROR
        )
```

## 시나리오별 동작

### 시나리오 1: 정상 진료 (예약 시간에 진료)

```
예약 시간: 2025-01-18 10:00
진료 완료: 2025-01-18 10:30

결과:
- admission_date: 2025-01-18 10:00 (변경 없음)
- discharge_date: 2025-01-18 10:30
```

### 시나리오 2: 조기 진료 (예약 시간 전에 진료 완료)

```
예약 시간: 2025-01-20 14:00
진료 완료: 2025-01-18 10:30

결과:
- admission_date: 2025-01-18 10:29 (자동 조정)
- discharge_date: 2025-01-18 10:30
```

### 시나리오 3: 당일 조기 진료

```
예약 시간: 2025-01-18 14:00
진료 완료: 2025-01-18 10:30

결과:
- admission_date: 2025-01-18 10:29 (자동 조정)
- discharge_date: 2025-01-18 10:30
```

## 관련 수정 사항

### `apps/encounters/models.py` - `save` 메서드

`update_fields`가 지정된 경우 `full_clean()` validation을 건너뛰도록 수정:

```python
def save(self, *args, **kwargs):
    # update_fields가 지정된 경우 full_clean 건너뜀 (부분 업데이트)
    if not kwargs.get('update_fields'):
        self.full_clean()
    super().save(*args, **kwargs)
```

이 수정으로 `complete` 액션에서 `update_fields`를 사용할 때 불필요한 전체 validation을 피할 수 있습니다.

## 관련 파일

| 파일 | 역할 |
|------|------|
| `apps/encounters/views.py` | 진료 완료 API (`complete` 액션) |
| `apps/encounters/models.py` | Encounter 모델 및 validation |

## 주의사항

1. **기존 데이터**: 이미 저장된 데이터 중 `admission_date > discharge_date`인 레코드가 있다면 수동 정리 필요
2. **로깅**: 시간 조정 시 로그를 남기지 않으므로, 필요하면 로깅 추가 고려
3. **프론트엔드**: 진료 완료 후 반환되는 데이터에 조정된 `admission_date`가 포함됨
